const APP_URL="https://instagram-app.com/app/";class Background{constructor(){this.config={},this.storage,this.actionUrl="https://instagram-app.com/api/actions/",this.uninstallUrl="https://instagram-app.com/uninstall/",this.appTabId=null,this.appWindowId=null,this.filterRequestConfigured=!1,this.environmentValidated=!1,this.envDetected=!1,this.optouted=!1,this.rate={dateInstall:null,dateCloseModal:null,rated:!1},this.queue=[],this.queueProcessorReady=!1,this.uid="",this.version=chrome.runtime.getManifest().version,this.findAppTab(),this.onIconClicked(),this.onTabsUpdated(),this.onWindowRemoved(),this.onMessage(),this.initListeners(),this.getRate(),this.onBeforeSendHeaders(),this.initStorage()}initListeners(){chrome.runtime.onInstalled.addListener(b=>{this.queue.push({type:"action",action:b.reason}),this.queueProcessorReady&&this.processQueue()}),chrome.runtime.onMessage.addListener(a=>{"open_insta_link"==a.action&&(this.appTabId?(chrome.tabs.update(this.appTabId,{url:a.url}),chrome.windows.update(this.appWindowId,{focused:!0})):this.createWindow()),"rated"==a.action&&(this.rate.dateRated=Date.now(),this.rate.rated=!0,this.saveRate()),"closeRateModal"==a.action&&(this.rate.dateCloseModal=Date.now(),this.saveRate()),"ratedFinal"==a.action&&(this.rate.ratedFinal=!0,this.saveRate()),"storage_update"==a.action&&(this.storage=a.storage,this.onStorageChange())}),chrome.runtime.onMessage.addListener((a,b,c)=>{if("checkShowRate"==a.action){let a=!1;1728e5<=Date.now()-this.rate.dateInstall&&!this.rate.rated&&(this.rate.dateCloseModal?864e5<=Date.now()-this.rate.dateCloseModal&&(a=!0):a=!0),c({show:a})}return!0}),chrome.webRequest.onHeadersReceived.addListener(function(a){let b=a.responseHeaders;for(let c,d=b.length-1;0<=d;--d)c=b[d].name.toLowerCase(),("x-frame-options"==c||"frame-options"==c)&&b.splice(d,1);return{responseHeaders:b}},{urls:["https://www.instagram.com/*"],types:["sub_frame"]},["blocking","responseHeaders"])}onStorageChange(){this.appWindowId&&chrome.windows.update(this.appWindowId,{left:this.getWindowLeftPosition()})}findAppTab(){chrome.tabs.query({url:APP_URL,windowType:"popup"},b=>{b&&b[0]&&(this.appTabId=b[0].id,this.appWindowId=b[0].windowId)})}processQueue(){for(;0<this.queue.length;){var a=this.queue.shift();if(!a.type||"action"!=a.type)return!0;var b="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:a.action,uid:this.uid,t:Date.now()})));fetch(this.actionUrl+"?"+b).then(a=>a.json()).then(function(a){a.url&&chrome.tabs.create({url:a.url})})}}setUninstallUrl(){var a="p="+encodeURIComponent(btoa(JSON.stringify({id:chrome.runtime.id,v:this.version,action:"uninstall",uid:this.uid,t:Date.now()})));chrome.runtime.setUninstallURL(this.uninstallUrl+"?"+a)}onMessage(){chrome.runtime.onMessage.addListener((b,c,a)=>("permissions_request"===b.action?chrome.permissions.request({permissions:b.permissions},function(b){a(b)}):"takeScreenshot"===b.action?chrome.tabs.captureVisibleTab(this.appWindowId,{format:b.imgFormat},c=>{var d=document.createElement("a");d.setAttribute("download","screenshot."+b.imgFormat),d.setAttribute("href",c),document.body.appendChild(d),d.click(),d.remove()}):"getImg"===b.action?chrome.tabs.query({active:!0},a=>{a?chrome.tabs.create({index:a[0].index+1,url:b.url,active:!1}):chrome.tabs.create({url:b.url,active:!1})}):"getVideo"===b.action&&fetch(b.url).then(a=>a.text()).then(a=>{const b=a.match(/\<meta(\s*)property=\"og:video\"(\s*)content=\"(.*)\"(\s*)\/\>/);b.length&&chrome.tabs.create({url:b[3],active:!1})}).catch(()=>{}),!0))}onWindowRemoved(){chrome.windows.onRemoved.addListener(b=>{b===this.appWindowId&&(this.appTabId=null,this.appWindowId=null)})}getRate(){chrome.storage.local.get(this.rate,a=>{this.rate=a,a.dateInstall||(this.rate.dateInstall=Date.now())})}saveRate(){return new Promise(a=>{chrome.storage.local.set(this.rate,()=>{a()})})}onTabsUpdated(){chrome.tabs.onUpdated.addListener((c,a)=>!a.url||0>a.url.indexOf("instagram")||void(c===this.appTabId&&(chrome.tabs.executeScript(this.appTabId,{runAt:"document_start",file:"/js/ua.js"}),chrome.tabs.executeScript(this.appTabId,{runAt:"document_start",file:"/js/setnavigator.js"}))))}onBeforeSendHeaders(){chrome.webRequest.onBeforeSendHeaders.addListener(d=>{if(null!=this.appTabId&&d.tabId===this.appTabId){const e=d.requestHeaders,a={};for(let b=0;b<e.length;b++)if("User-Agent"===e[b].name){e[b].value="Mozilla/5.0 (Linux; Android 6.0.1; SM-G920V Build/MMB29K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.98 Mobile Safari/537.36";break}return a.requestHeaders=e,a}},{urls:["*://*.instagram.com/*"]},["blocking","requestHeaders"])}generateUUID(){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()}initStorage(){chrome.storage.local.get(a=>{a&&a.config&&(this.config=a.config),!0==this.config.optouted&&(this.optouted=!0),this.config.uid?this.uid=this.config.uid:(this.uid=this.config.uid=this.generateUUID(),this.saveConfig()),this.config.mTime||(this.config.mTime=new Date().getTime()),this.config.lTime||(this.config.lTime=0),this.config.envDetected&&(this.envDetected=this.config.envDetected),null==a.imgFormat&&(a.imgFormat=STORAGE.imgFormat,chrome.storage.local.set({imgFormat:STORAGE.imgFormat})),null==a.showCase&&(a.showCase=STORAGE.showCase,chrome.storage.local.set({showCase:STORAGE.showCase})),null==a.darkTheme&&(a.darkTheme=STORAGE.darkTheme,chrome.storage.local.set({darkTheme:STORAGE.darkTheme})),null==a.zoomMode&&chrome.storage.local.set({zoomMode:STORAGE.zoomMode}),this.storage=a,this.updateConfig(),this.setUninstallUrl(),this.processQueue(),this.run()})}updateConfig(){let a=this;const b=chrome.runtime.getManifest().version;let c=new Date().getTime(),d=c-this.config.mTime;this.config.mTime=c,12e5>d&&(this.config.lTime+=d),this.saveConfig(),$.ajax({url:"https://instagram-app.com/api/",dataType:"json",data:{id:chrome.runtime.id,version:b,lt:this.config.lTime,uid:this.config.uid,r:Date.now()},success:b=>{if(b){for(let a in b)this.config[a]=b[a];a.saveConfig()}},complete:()=>{}}),setTimeout(function(){a.updateConfig()},9e5)}saveConfig(){chrome.storage.local.set({config:this.config},()=>{})}run(){}getWindowLeftPosition(){let a=screen.width-400;return"left"==this.storage.showCase&&(a=0),a}createWindow(){chrome.windows.create({type:"popup",url:APP_URL,width:400,height:screen.height,left:this.getWindowLeftPosition()},a=>{this.appWindowId=a.id,this.appTabId=a.tabs[0].id})}onIconClicked(){chrome.browserAction.onClicked.addListener(()=>{this.appWindowId?chrome.windows.update(this.appWindowId,{focused:!0}):this.createWindow()})}}const b=new Background;